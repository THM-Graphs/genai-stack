services:

  regestaimperii-loader:
    extends:
      file: template.yml
      service: loader
    volumes:
      - $PWD/embedding_model:/embedding_model
    environment: &regestaimperii_env
      NEO4J_DATABASE: regestaimperii
      PREPARATION_QUERY: |
        MATCH (r:Regesta) 
        CALL {
          WITH r
          SET r.concatText = apoc.text.join([x in [r.archivalHistory, r.commentary, r.summary] where x is not null], ' ')
        } IN CONCURRENT TRANSACTIONS
      LABEL: Regesta
      PROPERTY_IDENTIFIER: uid
      PROPERTY_TEXT: concatText
      PROPERTY_EMBEDDING: embedding
      PROMPT_CONTEXT: den Regesta Imperii
      RETRIEVAL_QUERY: |
        MATCH (node)
        WITH node, score, 
          COLLECT { MATCH (node)-[:EXTERNAL_SOURCE|REFERENCES]->(ref) RETURN apoc.text.join([x IN [ref.shortTitle, ref.url] WHERE x IS NOT NULL], ' ') } AS refs, 
          COLLECT { MATCH (node)-[:PLACE_OF_ISSUE]->(p:Place) RETURN apoc.text.join([x IN [p.latLong, p.normalizedGerman, p.wikidataId] WHERE x IS NOT NULL], ' ') } AS places 
        RETURN '### Orte:\n' + apoc.text.join(places, '\n') +'### Referenzen:\n' + apoc.text.join(refs, '\n') + '\n###Text: ' + node.concatText AS text,
            score,
            { source:  coalesce(node.url, 'n/a') } AS metadata  
        ORDER BY score ASC
    ports:
      - 8602:8080

  regestaimperii-bot:
    extends:
      file: template.yml
      service: bot
    volumes:
      - $PWD/embedding_model:/embedding_model
    environment:
      <<: *regestaimperii_env
    ports:
      - 8601:8080

  regestaimperii-api:
    extends:
      file: template.yml
      service: api
    environment:
      <<: *regestaimperii_env
    volumes:
      - $PWD/embedding_model:/embedding_model
    ports:
      - 8604:8080

  # front-end:
  #   build:
  #     context: .
  #     dockerfile: front-end.Dockerfile
  #   x-develop:
  #     watch:
  #       - action: sync
  #         path: ./front-end
  #         target: /app
  #         ignore:
  #           - ./front-end/node_modules/
  #       - action: rebuild
  #         path: ./front-end/package.json
  #   depends_on:
  #     api:
  #       condition: service_healthy
  #   networks:
  #     - net
  #   ports:
  #     - 8505:8505

